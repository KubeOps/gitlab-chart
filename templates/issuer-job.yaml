{{ if (pluck "configureCertmanager" .Values.global.ingress (dict "configureCertmanager" false) | first) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "gitlab.issuer_jobname" . }}
  labels:
    app: {{ template "name" . }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded
template:
  metadata:
    labels:
      app: {{ template "name" . }}
      release: {{ .Release.Name }}
  spec:
    {{- if .Values.rbac.create }}
    serviceAccountName: {{ template "fullname" . }}-admin
    {{- end }}
    restartPolicy: OnFailure
    containers:
      - name: create-issuer
        image: "{{ .Values.kubectl.image.repository }}:{{ .Values.kubectl.image.tag }}"
        command: ['/bin/bash', '/scripts/create-issuer', '/script/create_issuer']
        imagePullPolicy: {{ .Values.kubectl.image.pullPolicy }}
        volumeMounts:
          - name: scripts
            mountPath: /scripts
    volumes:
    - name: scripts
      configMap:
        name: {{ template "fullname" . }}-certmanager
{{- end }}
