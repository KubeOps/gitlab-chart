{{- if .Values.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "fullname" . }}-tests
data:
  test_login: |
    set -e
    echo 'Start Test'
    workhorse_service="{{ template "fullname" . }}:{{ .Values.service.workhorseExternalPort }}"
    signin_url="http://$workhorse_service/users/sign_in"
    echo "Testing loging page: $signin_url"
    csrf=$(curl $signin_url -S -c cookies.txt -s | grep -Po '<meta.*name="csrf-token".*content="\K[a-zA-Z0-9\+=\-\/]*')
    curl -S -X POST $signin_url  -c cookies.txt -s -F "authenticity_token=$csrf" -F 'user[login]=root' -F "user[password]=$(cat /initial_root_password)"
# Leave this here - This line denotes end of block to the parser.
{{- end }}
